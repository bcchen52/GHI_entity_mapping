country_count = {"Afghanistan": 0, "Albania": 0, "Algeria": 0, "Andorra": 0, "Angola": 0, "Antigua and Barbuda": 0, "Argentina": 0, "Armenia": 0, "Australia": 0, "Austria": 0, "Azerbaijan": 0, "Bahamas": 0, "Bahrain": 0, "Bangladesh": 0, "Barbados": 0, "Belarus": 0, "Belgium": 0, "Belize": 0, "Benin": 0, "Bhutan": 0, "Bolivia": 0, "Bosnia and Herzegovina": 0, "Botswana": 0, "Brazil": 0, "Brunei Darussalam": 0, "Bulgaria": 0, "Burkina Faso": 0, "Burundi": 0, "Cabo Verde": 0, "Cambodia": 0, "Cameroon": 0, "Canada": 0, "Central African Republic": 0, "Chad": 0, "Chile": 0, "China": 0, "Colombia": 0, "Comoros": 0, "Congo": 0, "Costa Rica": 0, "Croatia": 0, "Cuba": 0, "Cyprus": 0, "Czechia": 0, "Democratic People's Republic of Korea": 0, "Democratic Republic of the Congo": 0, "Denmark": 0, "Djibouti": 0, "Dominica": 0, "Dominican Republic": 0, "Ecuador": 0, "Egypt": 0, "El Salvador": 0, "Equatorial Guinea": 0, "Eritrea": 0, "Estonia": 0, "Eswatini": 0, "Ethiopia": 0, "Fiji": 0, "Finland": 0, "France": 0, "Gabon": 0, "Gambia": 0, "Georgia": 0, "Germany": 0, "Ghana": 0, "Greece": 0, "Grenada": 0, "Guatemala": 0, "Guinea": 0, "Guinea-Bissau": 0, "Guyana": 0, "Haiti": 0, "Honduras": 0, "Hungary": 0, "Iceland": 0, "India": 0, "Indonesia": 0, "Iran (Islamic Republic of)": 0, "Iraq": 0, "Ireland": 0, "Israel": 0, "Italy": 0, "Jamaica": 0, "Japan": 0, "Jordan": 0, "Kazakhstan": 0, "Kenya": 0, "Kiribati": 0, "Kuwait": 0, "Kyrgyzstan": 0, "Lao People's Democratic Republic": 0, "Latvia": 0, "Lebanon": 0, "Lesotho": 0, "Liberia": 0, "Libya": 0, "Lithuania": 0, "Luxembourg": 0, "Madagascar": 0, "Malawi": 0, "Malaysia": 0, "Maldives": 0, "Mali": 0, "Malta": 0, "Marshall Islands": 0, "Mauritania": 0, "Mauritius": 0, "Mexico": 0, "Micronesia (Federated States of)": 0, "Monaco": 0, "Mongolia": 0, "Montenegro": 0, "Morocco": 0, "Mozambique": 0, "Myanmar": 0, "Namibia": 0, "Nauru": 0, "Nepal": 0, "Netherlands": 0, "New Zealand": 0, "Nicaragua": 0, "Niger": 0, "Nigeria": 0, "North Macedonia": 0, "Norway": 0, "Oman": 0, "Pakistan": 0, "Palau": 0, "Panama": 0, "Papua New Guinea": 0, "Paraguay": 0, "Peru": 0, "Philippines": 0, "Poland": 0, "Portugal": 0, "Qatar": 0, "Republic of Korea": 0, "Republic of Moldova": 0, "Romania": 0, "Russian Federation": 0, "Rwanda": 0, "Saint Kitts and Nevis": 0, "Saint Lucia": 0, "Saint Vincent and the Grenadines": 0, "Samoa": 0, "San Marino": 0, "Sao Tome and Principe": 0, "Saudi Arabia": 0, "Senegal": 0, "Serbia": 0, "Seychelles": 0, "Sierra Leone": 0, "Singapore": 0, "Slovakia": 0, "Slovenia": 0, "Solomon Islands": 0, "Somalia": 0, "South Africa": 0, "South Sudan": 0, "Spain": 0, "Sri Lanka": 0, "Sudan": 0, "Suriname": 0, "Sweden": 0, "Switzerland": 0, "Syrian Arab Republic": 0, "Tajikistan": 0, "Thailand": 0, "Timor-Leste": 0, "Togo": 0, "Tonga": 0, "Trinidad and Tobago": 0, "Tunisia": 0, "Turkey": 0, "Turkmenistan": 0, "Tuvalu": 0, "Uganda": 0, "Ukraine": 0, "United Arab Emirates": 0, "United Kingdom": 0, "United Republic of Tanzania": 0, "United States of America": 0, "Uruguay": 0, "Uzbekistan": 0, "Vanuatu": 0, "Venezuela (Bolivarian Republic of)": 0, "Viet Nam": 0, "Yemen": 0, "Zambia": 0, "Zimbabwe": 0, "Côte d'Ivoire": 0}
country_region = {"Afghanistan": "EMR", "Albania": "EUR", "Algeria": "AFR", "Andorra": "EUR", "Angola": "AFR", "Antigua and Barbuda": "AMR", "Argentina": "AMR", "Armenia": "EUR", "Australia": "WPR", "Austria": "EUR", "Azerbaijan": "EUR", "Bahamas": "AMR", "Bahrain": "EMR", "Bangladesh": "SEA", "Barbados": "AMR", "Belarus": "EUR", "Belgium": "EUR", "Belize": "AMR", "Benin": "AFR", "Bhutan": "SEA", "Bolivia": "AMR", "Bosnia and Herzegovina": "EUR", "Botswana": "AFR", "Brazil": "AMR", "Brunei Darussalam": "WPR", "Bulgaria": "EUR", "Burkina Faso": "AFR", "Burundi": "AFR", "Cabo Verde": "AFR", "Cambodia": "WPR", "Cameroon": "AFR", "Canada": "AMR", "Central African Republic": "AFR", "Chad": "AFR", "Chile": "AMR", "China": "WPR", "Colombia": "AMR", "Comoros": "AFR", "Congo": "AFR", "Costa Rica": "AMR", "Croatia": "EUR", "Cuba": "AMR", "Cyprus": "EUR", "Czechia": "EUR", "Democratic People's Republic of Korea": "SEA", "Democratic Republic of the Congo": "AFR", "Denmark": "EUR", "Djibouti": "EMR", "Dominica": "AMR", "Dominican Republic": "AMR", "Ecuador": "AMR", "Egypt": "EMR", "El Salvador": "AMR", "Equatorial Guinea": "AFR", "Eritrea": "AFR", "Estonia": "EUR", "Eswatini": "AFR", "Ethiopia": "AFR", "Fiji": "WPR", "Finland": "EUR", "France": "EUR", "Gabon": "AFR", "Gambia": "AFR", "Georgia": "EUR", "Germany": "EUR", "Ghana": "AFR", "Greece": "EUR", "Grenada": "AMR", "Guatemala": "AMR", "Guinea": "AFR", "Guinea-Bissau": "AFR", "Guyana": "AMR", "Haiti": "AMR", "Honduras": "AMR", "Hungary": "EUR", "Iceland": "EUR", "India": "SEA", "Indonesia": "SEA", "Iran (Islamic Republic of)": "EMR", "Iraq": "EMR", "Ireland": "EUR", "Israel": "EUR", "Italy": "EUR", "Jamaica": "AMR", "Japan": "WPR", "Jordan": "EMR", "Kazakhstan": "EUR", "Kenya": "AFR", "Kiribati": "WPR", "Kuwait": "EMR", "Kyrgyzstan": "EUR", "Lao People's Democratic Republic": "WPR", "Latvia": "EUR", "Lebanon": "EMR", "Lesotho": "AFR", "Liberia": "AFR", "Libya": "EMR", "Lithuania": "EUR", "Luxembourg": "EUR", "Madagascar": "AFR", "Malawi": "AFR", "Malaysia": "WPR", "Maldives": "SEA", "Mali": "AFR", "Malta": "EUR", "Marshall Islands": "WPR", "Mauritania": "AFR", "Mauritius": "AFR", "Mexico": "AMR", "Micronesia (Federated States of)": "WPR", "Monaco": "EUR", "Mongolia": "WPR", "Montenegro": "EUR", "Morocco": "EMR", "Mozambique": "AFR", "Myanmar": "SEA", "Namibia": "AFR", "Nauru": "WPR", "Nepal": "SEA", "Netherlands": "EUR", "New Zealand": "WPR", "Nicaragua": "AMR", "Niger": "AFR", "Nigeria": "AFR", "North Macedonia": "EUR", "Norway": "EUR", "Oman": "EMR", "Pakistan": "EMR", "Palau": "WPR", "Panama": "AMR", "Papua New Guinea": "WPR", "Paraguay": "AMR", "Peru": "AMR", "Philippines": "WPR", "Poland": "EUR", "Portugal": "EUR", "Qatar": "EMR", "Republic of Korea": "WPR", "Republic of Moldova": "EUR", "Romania": "EUR", "Russian Federation": "EUR", "Rwanda": "AFR", "Saint Kitts and Nevis": "AMR", "Saint Lucia": "AMR", "Saint Vincent and the Grenadines": "AMR", "Samoa": "WPR", "San Marino": "EUR", "Sao Tome and Principe": "AFR", "Saudi Arabia": "EMR", "Senegal": "AFR", "Serbia": "EUR", "Seychelles": "AFR", "Sierra Leone": "AFR", "Singapore": "WPR", "Slovakia": "EUR", "Slovenia": "EUR", "Solomon Islands": "WPR", "Somalia": "EMR", "South Africa": "AFR", "South Sudan": "AFR", "Spain": "EUR", "Sri Lanka": "SEA", "Sudan": "EMR", "Suriname": "AMR", "Sweden": "EUR", "Switzerland": "EUR", "Syrian Arab Republic": "EMR", "Tajikistan": "EUR", "Thailand": "SEA", "Timor-Leste": "SEA", "Togo": "AFR", "Tonga": "WPR", "Trinidad and Tobago": "AMR", "Tunisia": "EMR", "Turkey": "EUR", "Turkmenistan": "EUR", "Tuvalu": "WPR", "Uganda": "AFR", "Ukraine": "EUR", "United Arab Emirates": "EMR", "United Kingdom": "EUR", "United Republic of Tanzania": "AFR", "United States of America": "AMR", "Uruguay": "AMR", "Uzbekistan": "EUR", "Vanuatu": "WPR", "Venezuela (Bolivarian Republic of)": "AMR", "Viet Nam": "WPR", "Yemen": "EMR", "Zambia": "AFR", "Zimbabwe": "AFR", "Côte d'Ivoire": "AFR"}
region_count = {"EMR": [0, 0], "EUR": [0, 0], "AFR": [0, 0], "SEA": [0, 0], "AMR": [0, 0], "WPR": [0, 0]}

import pandas as pd
import math
import sys
from pathlib import Path
base_dir = Path(__file__).resolve().parent

#fixes raw data by extraploating schist regional/country efficacy, then calculates impact

def createCleanModel(output):
    model = []

    df = pd.read_csv(f"{base_dir}/eff_data/schist_eff.csv")

    #1 to 315
    count = 0
    for i in range(1, 315):
        if "Praziquantel" == str(df.iloc[i,4]):
            name = str(df.iloc[i,3])
            #some inputs in the form of "COUNTRY "
            if name[len(name)-1] == " ":
                name = name[:-1]
            try:
                if country_count[name] == 0 and pd.notna(df.iloc[i,16]):
                    count += 1
                    country_count[name] = df.iloc[i,16]
                    #print(float(df.iloc[i,16][:-1])/100)
                    region = country_region[name]
                    region_count[region][0] += int(df.iloc[i,7]) * float(df.iloc[i,16][:-1])
                    region_count[region][1] += int(df.iloc[i,7])
            except KeyError:
                pass

    for i in region_count.keys():
        if region_count[i][0] != 0 and region_count[i][1] != 0:
            region_count[i][0] = round(region_count[i][0]/region_count[i][1], 1)
            
            #mark as calculated
            region_count[i][1] = 0

        #EDGE CASES, these 2 have no data
        elif i == "EUR":
            if region_count["EMR"][1] != 0:
                region_count[i][0] = round(region_count["EMR"][0]/region_count["EMR"][1], 1)
            else:
                region_count[i][0] = region_count["EMR"][0]
        elif i == "SEA":
            if region_count["WPR"][1] != 0:
                region_count[i][0] = round(region_count["WPR"][0]/region_count["WPR"][1], 1)
            else:
                region_count[i][0] = region_count["WPR"][0]
            
        #print(i + str(region_count[i][0]) + "%")

    df = pd.read_csv(output)

    df.iloc[1,46] = "Estimated"
    #SCHIT DALYS is 4
    #coverage is 20
    #prevalence is 30
    #endemic is 67
    #76 is impact
    #2 to 218
    #change col 46
    for i in range(2, 219):
        #countries in this don't necessarily line up

        if (df.iloc[i, 0] in country_count.keys() and country_count[df.iloc[i, 0]] != 0):
            df.iloc[i,46] = country_count[df.iloc[i, 0]]
        else:
            df.iloc[i,46] = str(region_count[df.iloc[i, 1]][0]) + "%"

        if int(df.iloc[i,67]) == 1 and pd.notna(df.iloc[i,46]) and len(df.iloc[i,46]) > 1 and pd.notna(df.iloc[i,20]) and len(df.iloc[i,20])> 1: #endemic
        #daly * eff * cov
            efficacy = float(df.iloc[i,46][:-1])/100
            coverage = float(df.iloc[i,20][:-1])/100
            dalys = float(str(df.iloc[i,4]).replace(",", ""))
            impact = round((dalys * efficacy * coverage)/(1 - efficacy * coverage), 3)
            df.iloc[i,76] = impact


        #print(df.iloc[i,46])
        
        #this uses abbreviated WHO region
        
    df.to_csv(output, index=False)

def main():
    years = [2010, 2013, 2015, 2017]
    if len(sys.argv) < 2:
        year = "ALL"
    else:
        year = int(sys.argv[1])

    if year == "ALL":
        for i in years:
            createCleanModel(f"{base_dir}/../raw_models/NTD_model_{i}.csv")
            print(f"{i} created.")
        print("Complete")
        return 0
    elif year in years:
        createCleanModel(f"{base_dir}/../raw_models/NTD_model_{year}.csv")
        print(f"{year} created.")
        print("Complete")
        return 0
    else:
        print("Cannot find year.")
    return 1

if __name__ == "__main__":
    main()